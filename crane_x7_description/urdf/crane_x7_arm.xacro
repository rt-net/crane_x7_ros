<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">
  <xacro:property name="M_PI" value="3.14159"/>
  <xacro:property name="SCALE_MM" value="0.001"/>
  <xacro:property name="SCALE_CM" value="0.01"/>

  <xacro:property name="BASE_FIXED_PART_HEIGHT" value="0.005"/>

  <!-- Macro for the standard CRANE X7 configuration -->
  <xacro:macro name="crane_x7_arm"
      params="parent
              end_effector_base_link
              base_color
              shoulder_color
              shoulder_joint_cover_color
              upper_arm_upper_color
              upper_arm_lower_color
              elbow_joint_cover_color
              lower_arm_upper_color
              lower_arm_lower_color
              wrist_color
              joints_vlimit
              shoulder_llimit
              shoulder_ulimit
              logos_definition
              *origin">

    <!-- Shoulder -->
    <crane_x7_base
        parent="${parent}"
        name="crane_x7_shoulder"
        fixed_part_color="${base_color}"
        pan_vlimit="${joints_vlimit}"
        pan_llimit="${shoulder_llimit}"
        pan_ulimit="${shoulder_ulimit}"
        revolute_part_color="${shoulder_color}"
        tilt_vlimit="${joints_vlimit}"
        tilt_llimit="-${M_PI/2}"
        tilt_ulimit="${M_PI/2}"
        attached_link="crane_x7_upper_arm_fixed_part_link">
      <xacro:insert_block name="origin"/>
    </crane_x7_base>

    <!-- Upper arm -->
    <crane_x7_type_1_rotating_link
        name="crane_x7_upper_arm"
        fixed_part_color="${upper_arm_upper_color}"
        twist_vlimit="${joints_vlimit}"
        twist_llimit="-${M_PI/2}"
        twist_ulimit="${M_PI/2}"
        revolute_part_color="${upper_arm_lower_color}"
        rotate_vlimit="${joints_vlimit}"
        rotate_llimit="-2.80718"
        rotate_ulimit="0.04141"
        joint_cover_color="${shoulder_joint_cover_color}"
        attached_link="crane_x7_lower_arm_fixed_part_link"/>

    <!-- Lower arm -->
    <crane_x7_type_2_rotating_link
        name="crane_x7_lower_arm"
        fixed_part_color="${lower_arm_upper_color}"
        twist_vlimit="${joints_vlimit}"
        twist_llimit="-2.77343"
        twist_ulimit="1.51403"
        revolute_part_color="${lower_arm_lower_color}"
        rotate_vlimit="${joints_vlimit}"
        rotate_llimit="-${M_PI/2}"
        rotate_ulimit="${M_PI/2}"
        joint_cover_color="${elbow_joint_cover_color}"
        attached_link="crane_x7_wrist_link"
        logos_definition="${logos_definition}">
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </crane_x7_type_2_rotating_link>

    <!-- Wrist -->
    <crane_x7_wrist
        name="crane_x7_wrist"
        color="${wrist_color}"
        vlimit="${joints_vlimit}"
        llimit="-2.96365"
        ulimit="2.97132"
        attached_link="${end_effector_base_link}">
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </crane_x7_wrist>
  </xacro:macro>


  <!-- Composite parts -->

  <!-- Base pan/tilt-like joint -->
  <xacro:macro name="crane_x7_base"
      params="parent name
      fixed_part_color pan_vlimit pan_llimit pan_ulimit
      revolute_part_color tilt_vlimit tilt_llimit tilt_ulimit attached_link *origin">
    <crane_x7_base_fixed_part
        parent="${parent}"
        name="${name}_fixed_part"
        color="${fixed_part_color}"
        vlimit="${pan_vlimit}"
        llimit="${pan_llimit}"
        ulimit="${pan_ulimit}"
        attached_link="${name}_revolute_part_link">
      <xacro:insert_block name="origin"/>
    </crane_x7_base_fixed_part>

    <crane_x7_base_revolute_part
        name="${name}_revolute_part"
        color="${revolute_part_color}"
        vlimit="${tilt_vlimit}"
        llimit="${tilt_llimit}"
        ulimit="${tilt_ulimit}"
        attached_link="${attached_link}"/>
  </xacro:macro>

  <!-- Long link with twist capability -->
  <xacro:macro name="crane_x7_type_1_rotating_link"
      params="name
      fixed_part_color twist_vlimit twist_llimit twist_ulimit
      revolute_part_color rotate_vlimit rotate_llimit rotate_ulimit
      joint_cover_color attached_link">
    <crane_x7_rotating_link_1_fixed_part
        name="${name}_fixed_part"
        color="${fixed_part_color}"
        joint_cover_color="${joint_cover_color}"/>

    <crane_x7_rotating_link_1_revolute_part
        parent="${name}_fixed_part_link"
        name="${name}_revolute_part"
        color="${revolute_part_color}"
        twist_vlimit="${twist_vlimit}"
        twist_llimit="${twist_llimit}"
        twist_ulimit="${twist_ulimit}"
        rotate_vlimit="${rotate_vlimit}"
        rotate_llimit="${rotate_llimit}"
        rotate_ulimit="${rotate_ulimit}"
        attached_link="${attached_link}"/>
  </xacro:macro>

  <!-- Arm-to-wrist link with twist capability -->
  <xacro:macro name="crane_x7_type_2_rotating_link"
      params="name
      fixed_part_color twist_vlimit twist_llimit twist_ulimit
      revolute_part_color rotate_vlimit rotate_llimit rotate_ulimit
      joint_cover_color attached_link logos_definition *origin">
    <crane_x7_rotating_link_2_fixed_part
        name="${name}_fixed_part"
        color="${fixed_part_color}"
        vlimit="${twist_vlimit}"
        llimit="${twist_llimit}"
        ulimit="${twist_ulimit}"
        joint_cover_color="${joint_cover_color}"
        attached_link="${name}_revolute_part_link">
      <xacro:insert_block name="origin"/>
    </crane_x7_rotating_link_2_fixed_part>

    <crane_x7_rotating_link_2_revolute_part
        name="${name}_revolute_part"
        color="${revolute_part_color}"
        vlimit="${rotate_vlimit}"
        llimit="${rotate_llimit}"
        ulimit="${rotate_ulimit}"
        attached_link="${attached_link}"
        logos_definition="${logos_definition}">
      <xacro:insert_block name="origin"/>
    </crane_x7_rotating_link_2_revolute_part>
  </xacro:macro>


  <!-- Individual parts -->

  <!-- Mountable part of base -->
  <xacro:macro name="crane_x7_base_fixed_part"
      params="parent name color vlimit llimit ulimit attached_link *origin">
    <!-- Fixed joint to the mounting point -->
    <joint name="${name}_mount_joint" type="fixed">
      <xacro:insert_block name="origin"/>
      <parent link="${parent}"/>
      <child link="${name}_link"/>
    </joint>

    <!-- Main link -->
    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/base_fixed_part.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/base_fixed_part.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.387313"/>
        <origin xyz="-0.00669 0.000049 0.017868" rpy="0 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <!-- Pan joint of the shoulder -->
    <joint name="${name}_pan_joint" type="revolute">
      <origin xyz="0 0 ${BASE_FIXED_PART_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit effort="0.5" velocity="${vlimit}" lower="${llimit}" upper="${ulimit}"/>
      <parent link="${name}_link"/>
      <child link="${attached_link}"/>
    </joint>
  </xacro:macro>
  <xacro:property name="BASE_FIXED_PART_JOINT_Z" value="0.036"/>

  <!-- Rotated part of base -->
  <xacro:macro name="crane_x7_base_revolute_part"
      params="name color vlimit llimit ulimit attached_link">
    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 ${M_PI}"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/base_revolute_part.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 ${M_PI}"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/base_revolute_part.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.235377"/>
        <origin xyz="0.000013 -0.000407 0.046345" rpy="0 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <!-- Tilt joint of the shoulder -->
    <joint name="${name}_tilt_joint" type="revolute">
      <origin xyz="0 0 ${BASE_REVOLUTE_PART_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="0.5" velocity="${vlimit}" lower="${llimit}" upper="${ulimit}"/>
      <parent link="${name}_link"/>
      <child link="${attached_link}"/>
    </joint>
  </xacro:macro>
  <xacro:property name="BASE_REVOLUTE_PART_JOINT_Z" value="0.064"/>

  <!-- "Fixed" part of long twistable link -->
  <xacro:macro name="crane_x7_rotating_link_1_fixed_part"
    params="name color joint_cover_color">
    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/rotating_link_type_1_fixed_part.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/rotating_link_type_1_fixed_part.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.120005"/>
        <origin xyz="0.000036 0.037855 -0.00018" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <!-- Joint covers -->
    <!-- TODO: Once rviz fixes its multi-material display bug, move these into the parent link -->
    <link name="${name}_joint_cover_l_link">
      <visual>
        <origin xyz="0 0 0" rpy="-${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${joint_cover_color}"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="-${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="0.005"/>
        <origin xyz="0.000036 0.037855 -0.00018" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>
    <joint name="${name}_joint_cover_l_joint" type="fixed">
      <parent link="${name}_link"/>
      <child link="${name}_joint_cover_l_link"/>
      <origin xyz="0 0.0316 0" rpy="0 0 0"/>
    </joint>
    <link name="${name}_joint_cover_r_link">
      <visual>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${joint_cover_color}"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="0.005"/>
        <origin xyz="0.000036 0.037855 -0.00018" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>
    <joint name="${name}_joint_cover_r_joint" type="fixed">
      <parent link="${name}_link"/>
      <child link="${name}_joint_cover_r_link"/>
      <origin xyz="0 -0.0316 0" rpy="0 0 0"/>
    </joint>
  </xacro:macro>
  <xacro:property name="TYPE_1_FIXED_PART_JOINT_Z" value="0.065"/>

  <!-- Rotating part of long twistable link -->
  <xacro:macro name="crane_x7_rotating_link_1_revolute_part"
      params="parent name color twist_vlimit twist_llimit twist_ulimit
        rotate_vlimit rotate_llimit rotate_ulimit attached_link">
    <!-- Joint for twisting around long axis -->
    <joint name="${name}_twist_joint" type="revolute">
      <origin xyz="0 0 ${TYPE_1_FIXED_PART_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit effort="0.5"
          velocity="${twist_vlimit}"
          lower="${twist_llimit}"
          upper="${twist_ulimit}"/>
      <parent link="${parent}"/>
      <child link="${name}_link"/>
    </joint>

    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/rotating_link_type_1_revolute_part.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/rotating_link_type_1_revolute_part.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.340878"/>
        <origin xyz="-0.011533 0.000021 0.083707" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <!-- Joint for rotating the attached part -->
    <joint name="${name}_rotate_joint" type="revolute">
      <origin xyz="0 0 ${TYPE_1_REVOLUTE_PART_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 -1 0"/>
      <limit effort="0.5"
          velocity="${rotate_vlimit}"
          lower="${rotate_llimit}"
          upper="${rotate_ulimit}"/>
      <parent link="${name}_link"/>
      <child link="${attached_link}"/>
    </joint>
  </xacro:macro>
  <xacro:property name="TYPE_1_REVOLUTE_PART_JOINT_Z" value="0.185"/>

  <!-- "Fixed" part of arm-to-wrist twistable link -->
  <xacro:macro name="crane_x7_rotating_link_2_fixed_part"
      params="name color vlimit llimit ulimit joint_cover_color attached_link *origin">
    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/rotating_link_type_2_fixed_part.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/rotating_link_type_2_fixed_part.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.230634"/>
        <origin xyz="-0.008641 0.083071 -0.000086" rpy="${M_PI} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <joint name="${name}_joint" type="revolute">
      <origin xyz="0 0 ${TYPE_2_FIXED_PART_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit effort="0.5" velocity="${vlimit}" lower="${llimit}" upper="${ulimit}"/>
      <parent link="${name}_link"/>
      <child link="${attached_link}"/>
    </joint>

    <!-- Joint covers -->
    <!-- TODO: Once rviz fixes its multi-material display bug, move these into the parent link -->
    <link name="${name}_joint_cover_l_link">
      <visual>
        <origin xyz="0 0 0" rpy="-${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${joint_cover_color}"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="-${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="0.005"/>
        <origin xyz="0.000036 0.037855 -0.00018" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>
    <joint name="${name}_joint_cover_l_joint" type="fixed">
      <parent link="${name}_link"/>
      <child link="${name}_joint_cover_l_link"/>
      <origin xyz="0 0.025 0" rpy="0 0 0"/>
    </joint>
    <link name="${name}_joint_cover_r_link">
      <visual>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${joint_cover_color}"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/joint_cover.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="0.005"/>
        <origin xyz="0.000036 0.037855 -0.00018" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>
    <joint name="${name}_joint_cover_r_joint" type="fixed">
      <parent link="${name}_link"/>
      <child link="${name}_joint_cover_r_link"/>
      <origin xyz="0 -0.025 0" rpy="0 0 0"/>
    </joint>
  </xacro:macro>
  <xacro:property name="TYPE_2_FIXED_PART_JOINT_Z" value="0.121"/>

  <!-- Rotating part of arm-to-wrist twistable link -->
  <xacro:macro name="crane_x7_rotating_link_2_revolute_part"
      params="name color vlimit llimit ulimit attached_link logos_definition *origin">
    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/rotating_link_type_2_revolute_part.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/rotating_link_type_2_revolute_part.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.192709"/>
        <origin xyz="-0.000024 0.001285 0.063837" rpy="0 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <joint name="${name}_joint" type="revolute">
      <origin xyz="0 0 ${TYPE_2_REVOLUTE_PART_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="0.5" velocity="${vlimit}" lower="${llimit}" upper="${ulimit}"/>
      <parent link="${name}_link"/>
      <child link="${attached_link}"/>
    </joint>

    <!-- Logos -->
    <!-- TODO: Once rviz fixes its multi-material display bug, move these into the parent link -->
    <xacro:include filename="${logos_definition}"/>
    <crane_x7_logos parent="${name}_link"/>
  </xacro:macro>
  <xacro:property name="TYPE_2_REVOLUTE_PART_JOINT_Z" value="0.129"/>

  <!-- Wrist (end effector attachment link) -->
  <xacro:macro name="crane_x7_wrist"
      params="name color vlimit llimit ulimit attached_link *origin">
    <link name="${name}_link">
      <visual>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/visual/wrist.stl"
              scale="1 1 1"/>
        </geometry>
        <material name="${color}"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/>
        <geometry>
          <mesh filename="package://crane_x7_description/meshes/collision/wrist.stl"
              scale="1 1 1"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="0.130549"/>
        <origin xyz="0.005713 -0.003707 0.000781" rpy="${M_PI/2} 0 0"/>
        <inertia ixx="1" ixy="0.0" ixz="0.0"
          iyy="1" iyz="0.0"
          izz="1"/>
      </inertial>
    </link>

    <joint name="${name}_joint" type="revolute">
      <origin xyz="0 0 ${WRIST_JOINT_Z}" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit effort="0.5" velocity="${vlimit}" lower="${llimit}" upper="${ulimit}"/>
      <parent link="${name}_link"/>
      <child link="${attached_link}"/>
    </joint>
  </xacro:macro>
  <xacro:property name="WRIST_JOINT_Z" value="0.019"/>
</robot>
